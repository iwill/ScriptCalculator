<!DOCTYPE html>
<html>
<head>
<!--
    Created by MingLQ on 2019-11-22.
    Copyright Â© 2019 MingLQ <minglq.9@gmail.com>. Released under the MIT license.
-->
<title>ScriptCalculator by MingLQ</title>
<meta name="viewport" content="width=device-width, user-scalable=yes" />
<style type="text/css" media="all">
    html {
        --margin: 8px;
        --space-l: var(--margin);
        --space: 5px;
    }
    body {
        --top-height: 30px;
        --right-width: 25%;
        --ln-width: 20px;
    }
    
    html {
        box-sizing: border-box;
        font-family: monospace;
        font-size: 13px;
    }
    *, *:before, *:after {
        box-sizing: inherit;
        font-family: inherit;
        font-size: inherit;
    }
    html {
        height: 100%;
        padding: 0;
    }
    body {
        height: calc(100% - var(--margin) * 2);
        margin: var(--margin);
        padding: 0;
    }
    
    #right {
        width: var(--right-width);
        margin: 0 0 0 var(--space-l);
        position: relative;
    }
    #left {
        width: calc(100% - var(--right-width) - var(--space-l));
        margin: 0;
    }
    .container {
        height: calc(100% - var(--top-height) - var(--space) * 2);
        float: left;
        display: inline-block;
        line-height: 0;
    }
    
    #script {
        text-align: right;
    }
    #result {
        padding-left: calc(var(--ln-width) + var(--space));
    }
    #lineNumber {
        pointer-events: none;
        position: absolute;
        left: 0;
        top: 0;
        width: var(--ln-width);
        padding: var(--space) 1px;
        border-color: transparent;
        background-clip: padding-box;
        background-color: #00000008;
        color: #AAAAAA;
        text-align: right;
    }
    .code {
        width: 100%;
        height: 100%;
        resize: none;
        margin: 0;
        padding: var(--space);
        border-style: solid;
        border-width: 1px;
        border-color: gray;
        line-height: 15px;
        white-space: pre;
        word-wrap: normal; /* for Safari */
        overflow-x: scroll;
    }
    #script::-webkit-scrollbar,
    #lineNumber::-webkit-scrollbar {
        width: 0;
        height: 0;
        background: transparent;
    }
</style>
</head>
<body>
    <!-- TODO: overflow: scroll / hide left; -->
    <div style="height: var(--top-height); position: relative; overflow-x: scroll;">
        <div style="position: absolute; left: 0; top: 0; padding: var(--space) 0;">
            ScriptCalculator by MingLQ [<a href="https://github.com/iwill/ScriptCalculator" target="blank">GitHub</a>]
        </div>
        <div style="position: absolute; right: 0; top: 0; padding: var(--space) 0;">
            DecimalDigits: <select id="decimalDigits" onchange="calculate(event, this)">
                <option value="-1">--</option><option value="0">0</option>
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
                <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
                <option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option>
            </select>
            <!--
            TODO: FixedPoint: <select id="fixedPoint" onchange="calculate(event, this)">
                <option value="-1">--</option>
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
                <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
                <option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option>
            </select>
            -->
            RoundingMethod: <select id="roundingMethod" onchange="calculate(event, this)">
                <option value="round">round</option><option value="floor">floor</option><option value="ceil">ceil</option>
            </select>
            <button id="reset" onclick="resetSetting(event, this)">reset</button>
            <!--
            |
            <button id="clear" onclick="clearSource(event, this)">clear</button>
            -->
            |
            <button id="copy" onclick="copyOutput(event, this)">copy</button>
            <button id="share" disabled="disabled">share</button>
            <!--
            TODO: share script+settings via link#hash
            share with #hash, but not change the href
            ???: alert for overwriting
            !!!: or supports history
            -->
        </div>
    </div>
    <div id="left" class="container">
        <textarea id="script" class="code" oninput="calculate(event, this)" onkeydown="shortcuts(event, this)" onscroll="syncScrolling(event, this)"></textarea>
    </div>
    <div id="right" class="container">
        <textarea readonly id="result" class="code" onscroll="syncScrolling(event, this)"></textarea>
        <textarea readonly id="lineNumber" class="code" onscroll="syncScrolling(event, this)"></textarea>
        <textarea readonly id="output" style="display: hidden; position: fixed; right: 0; bottom: 0; width: 0; height: 0;"></textarea>
    </div>
</body>
<script type="text/javascript">
    
    function Radix(number, radix) {
        let prefix = (radix == 2) ? "0b" : (radix == 8) ? "0o" : (radix == 16) ? "0x" : "";
        this.number = number;
        this.display = prefix + number.toString(radix).toUpperCase();
    }
    Math.format = function(number, radix) {
        return new Radix(number, radix);
    };
    
    for (let method of ["round", "floor", "ceil"]) {
        let _method = "_" + method;
        Math[_method] = Math[method];
        Math[method] = function(number, len) {
            len = len || 0;
            if (this.abs(len) > 100) return number;
            len = len > 0 ? this._floor(len) : this._ceil(len);
            let m = this.pow(10, len);
            return this[_method](number * m) / m;
        };
    }
    
    Math.GR = Math.sqrt(1.25) - 0.5; // Golden Ratio
    
    const resultTypes = ["number", "boolean"];
    
    // querySelector || querySelectorAll
    let $script = document.querySelector("#script");
    let $result = document.querySelector("#result");
    let $lineNumber = document.querySelector("#lineNumber");
    let $output = document.querySelector("#output");
    let $decimalDigits = document.querySelector("#decimalDigits");
    // let $fixedPoint = document.querySelector("#fixedPoint");
    let $roundingMethod = document.querySelector("#roundingMethod");
    
    function calculate(event, target) {
        localStorage.setItem("data.script", $script.value);
        localStorage.setItem("setting.decimalDigits", $decimalDigits.selectedIndex);
        // localStorage.setItem("setting.fixedPoint", $fixedPoint.selectedIndex);
        localStorage.setItem("setting.roundingMethod", $roundingMethod.selectedIndex);
        
        $roundingMethod.disabled = ($decimalDigits.selectedIndex == 0);
        
        /// prepare
        let script = $script.value
        .replace(/===/g, "==").replace(/==/g, "=").replace(/=/g, "==") // =, ==, === >> ==
        .replace(/==\s*\/\//, "//") // before comments
        .replace(/==\s*\n/, "\n") // before end of line
        .replace(/==\s*$/, ""); // bofore end of string
        
        // TODO: value.toLocaleString(undefined, {style: "decimal"/"currency"/"percent", currency: "USD"/"EUR"/"CNY", useGrouping: true});
        // #see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/toLocaleString
        // let display = value.toLocaleString();
        /* TODO: lines [{
            result: number / "" / "ERROR",
            display: formatted-number / "" / "ERROR",
            lineNumber: number / "",
            output: `code = value // comment`
        }, ...] */
        let result = [], lineNumber = [], output = [];
        let values = [], variables = {}, functions = {};
        for (line of script.split("\n")) {
            line = line.trim();
            
            let code, func, comment;
            let value, display;
            try {
                if (values.length >= 99) {
                    throw "too many calculations";
                }
                
                /// validate
                let commentIndex = line.indexOf("//");
                code = commentIndex >= 0 ? line.slice(0, commentIndex).trim() : line;
                comment = commentIndex >= 0 ? line.slice(commentIndex).trim() : null;
                // symbols
                if (/[\[\]\{\}'"\\;]/g.test(code)) {
                    throw "invalid symbol in `" + line + "`";
                }
                // `dot [spaces] (word-start) (no-number) words (word-end) [spaces] left-parenthesis`
                if (/\.\s*[A-z_][A-z0-9_]*\s*\(/g.test(code)) {
                    throw "invalid dot in `" + line + "`";
                }
                
                let funcName;
                let funcArgs;
                let variable;
                
                /// find `function`
                // `fun([arg0[, argN]*]?):`
                // let regExp = /^(?<name>[A-z_][A-z0-9_]*)\s*(?<args>\((\s*[A-z_][A-z0-9_]*\s*(,\s*[A-z_][A-z0-9_]*\s*)*)?\))\:/;
                // tagged templates:
                // #see https://stackoverflow.com/questions/12317049/how-to-split-a-long-regular-expression-into-multiple-lines-in-javascript
                // #see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals
                let makeRegExp = (regExp, opts) => new RegExp(regExp.raw[0].replace(/\s/mg, ""), opts || "");
                // `[A-z_][A-z0-9_]*` == `\b(?!\d)\w+\b`
                let regExp = makeRegExp`
                    ^ \s*
                    (?<name> [A-z_][A-z0-9_]* ) \s*
                    (?<args>
                        \( \s*
                        (
                                  [A-z_][A-z0-9_]* \s*
                            (,\s* [A-z_][A-z0-9_]* \s* )*
                        )?
                        \)
                    ) \s*
                    \:
                `; // `${"img"}`
                
                let funcMatches = code.match(regExp);
                if (funcMatches) {
                    funcName = funcMatches.groups.name;
                    if (Math[funcName]) {
                        throw "ivalid func in `" + line + "`";
                    }
                    funcArgs = funcMatches.groups.args;
                    code = code.slice(funcMatches.index + funcMatches[0].length).trim();
                }
                
                /// find `variable`
                // `(word-start) (no-number) words (word-end) colon`
                let variableMatches = code.match(/^[A-z_][A-z0-9_]*\s*\:/);
                if (variableMatches) {
                    variable = variableMatches[0].slice(0, -1).trim();
                    if (Math[variable]) {
                        throw "ivalid variable in `" + line + "`";
                    }
                    code = code.slice(variableMatches.index + variableMatches[0].length).trim();
                }
                
                /// validate and insert namespace
                // `(word-start) (no-number) words (word-end) [spaces] (left-parenthesis)`
                code = code.replace(/[A-z_][A-z0-9_]*\s*(?=\()/g, function(name) {
                    name = name.trim();
                    if ((!functions[name] && !Math[name]) || ["prototype", "toSource", "valueOf"].includes(name)) {
                        throw "invalid function in `" + line + "`";
                    }
                    return functions[name] && !Math[name] ? ("functions." + name) : name;
                });
                
                /// replace `variable`
                // `(word-start) (no-number) words (word-end) [spaces] (no-left-parenthesis)`
                code = code.replace(/[A-z_][A-z0-9_]*\s*(?!\()\b/g, function(l) {
                    let v = variables[l];
                    return v !== undefined ? v : l; // `l` but NOT undefined for PI, NaN, MIN_VALUE, MAX_VALUE, ...
                });
                
                /// replace `$x`
                /// prepend `$` if `(line-start) (no-dollar) (no-left-parenthesis) (no-words)`
                if (resultTypes.includes(typeof result[result.length - 1]) && code.length && !code.match(/^[\$\(\w]+/)) {
                    code = "$ " + code;
                }
                // `dollar [numbers]`
                code = code.replace(/\$\d*/g, function($x) {
                    if ($x == "$" || $x == "$0") return variables.$;
                    let i = Number($x.slice(1)) - 1;
                    return i >= 0 && i < values.length ? values[i] : undefined;
                });
                
                /// eval
                with (Math) {
                    if (funcName && funcArgs) {
                        eval("functions." + funcName + " = " + funcArgs + " => " + code + ";");
                        func = funcName + funcArgs + ": " + code;
                    }
                    else {
                        value = eval(code);
                    }
                }
                console.log(value ? (code + " = " + value) : code);
                
                if (value instanceof Radix) {
                    display = value.display;
                    value = value.number;
                }
                
                /// variables
                let type = typeof value;
                if (type == "number") {
                    let decimalDigits = Number($decimalDigits.value);
                    if (decimalDigits >= 0) {
                        let roundingMethod = $roundingMethod.value;
                        value = Math[roundingMethod](value, decimalDigits);
                    }
                    variables.$ = value;
                    if (variable) variables[variable] = value;
                }
                else if (type == "boolean") {
                    variables.$ = value;
                    if (variable) variables[variable] = value;
                }
                else if (value) {
                    throw "invalid expression in `" + line + "`";
                }
            }
            catch(e) {
                console.warn(e);
                value = "ERROR";
            }
            
            /// result
            result.push(display || value);
            comment = comment ? (" " + comment) : "";
            if (resultTypes.includes(typeof value)) {
                values.push(value);
                lineNumber.push((values.length < 10 ? " " : "") + values.length);
                output.push(code.replace(/\s*functions\.\s*/g, "") + " = " + value + comment);
            }
            else {
                lineNumber.push("");
                output.push((func || "") + comment);
            }
        }
        
        /// output
        // let fixed = result.map((name, index) => name ? Number(name).toFixed(2) : name);
        $result.value = result.join("\n");
        $lineNumber.value = lineNumber.join("\n");
        $output.value = output.join("\n");
    }
    
    function shortcuts(event, target) {
        if (document.activeElement != $script
            || event.altKey || event.metaKey || event.repeat || event.isComposing) {
            return;
        }
        
        var key = event.key.toLowerCase();
        if (event.ctrlKey && ["c", "u"].includes(key)) {
            let script = $script.value;
            let start = $script.selectionStart, end = $script.selectionEnd;
            if (start == end) {
                while (start > 0 && script[start - 1].match(/[\w$]/)) {
                    start -= 1;
                }
                while (end < script.length - 1 && script[end].match(/[\w$]/)) {
                    end += 1;
                }
            }
            
            let selection = script.substring(start, end);
            if (key == "c") {
                selection = selection[0][event.shiftKey ? "toLowerCase" : "toUpperCase"]() + selection.substring(1);
            }
            else {
                selection = selection[event.shiftKey ? "toLowerCase" : "toUpperCase"]();
            }
            
            $script.selectionStart = start;
            $script.selectionEnd = end;
            document.execCommand("insertText", false, selection); // enable undo
            $script.selectionStart = start;
            $script.selectionEnd = end;
            
            calculate(null, target);
        }
    }
    
    function resetSetting(event, target) {
        $decimalDigits.selectedIndex = 0;
        // $fixedPoint.selectedIndex = 0;
        $roundingMethod.selectedIndex = 0;
        calculate(null, target);
    }
    
    function clearSource(event, target) {
        $script.select();
        document.execCommand("insertText", false, ""); // enable undo
        calculate(null, target);
    }
    
    function copyOutput(event, target) {
        $output.focus();
        $output.select();
        document.execCommand("copy");
        (target || $script).focus();
    }
    
    function syncScrolling(event, target) {
        [$script, $result, $lineNumber].forEach(function(e, i) {
            e.scrollTop = target.scrollTop;
        });
    }
    
    $decimalDigits.selectedIndex = localStorage.getItem("setting.decimalDigits");
    // $fixedPoint.selectedIndex = localStorage.getItem("setting.fixedPoint");
    $roundingMethod.selectedIndex = localStorage.getItem("setting.roundingMethod");
    $script.value = localStorage.getItem("data.script") || localStorage.getItem("data.src");
    
    $script.focus();
    calculate(null, null);
    
</script>
</html>
