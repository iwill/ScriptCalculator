<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<!--
    Created by MingLQ on 2019-11-22.
    Copyright Â© 2019 MingLQ <minglq.9@gmail.com>. Released under the MIT license.
-->
<title>ScriptCalculator by MingLQ</title>
<meta name="viewport" content="width=device-width, user-scalable=yes" />
<style type="text/css" media="all">
    html {
        --margin: 8px;
        --space-l: var(--margin);
        --space: 5px;
    }
    body {
        --top-height: 30px;
        --right-width: 25%;
        --ln-width: 20px;
    }
    
    html {
        box-sizing: border-box;
        font-family: monospace;
        font-size: 13px;
    }
    *, *:before, *:after {
        box-sizing: inherit;
        font-family: inherit;
        font-size: inherit;
    }
    html {
        height: 100%;
        padding: 0;
    }
    body {
        height: calc(100% - var(--margin) * 2);
        margin: var(--margin);
        padding: 0;
    }
    
    #right {
        width: var(--right-width);
        margin: 0 0 0 var(--space-l);
        position: relative;
    }
    #left {
        width: calc(100% - var(--right-width) - var(--space-l));
        margin: 0;
    }
    .container {
        height: calc(100% - var(--top-height) - var(--space) * 2);
        float: left;
        display: inline-block;
        line-height: 0;
    }
    
    #src {
        text-align: right;
    }
    #res {
        padding-left: calc(var(--ln-width) + var(--space));
    }
    #ln {
        pointer-events: none;
        position: absolute;
        left: 0;
        top: 0;
        width: var(--ln-width);
        padding: var(--space) 1px;
        border-color: transparent;
        background-clip: padding-box;
        background-color: #00000008;
        color: #AAAAAA;
        text-align: right;
    }
    .code {
        width: 100%;
        height: 100%;
        resize: none;
        margin: 0;
        padding: var(--space);
        border-style: solid;
        border-width: 1px;
        border-color: gray;
        line-height: 15px;
        white-space: pre;
        word-wrap: normal; /* for Safari */
        overflow-x: scroll;
    }
    #src::-webkit-scrollbar,
    #ln::-webkit-scrollbar {
        width: 0;
        height: 0;
        background: transparent;
    }
</style>
</head>
<body>
    <!-- TODO: overflow: scroll / hide left; -->
    <div style="height: var(--top-height); position: relative; overflow-x: scroll;">
        <div style="position: absolute; left: 0; top: 0; padding: var(--space) 0;">
            ScriptCalculator by MingLQ [<a href="https://github.com/iwill/ScriptCalculator" target="blank">GitHub</a>]
        </div>
        <div style="position: absolute; right: 0; top: 0; padding: var(--space) 0;">
            DecimalDigits: <select id="decimalDigits" onchange="calculate(event, this.id)">
                <option value="-1">--</option>
                <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option>
                <option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option>
                <option value="15">15</option><option value="16">16</option>
            </select>
            RoundingMethod: <select id="roundingMethod" onchange="calculate(event, this.id)">
                <option value="round">round</option><option value="floor">floor</option><option value="ceil">ceil</option>
            </select>
            <button id="reset" onclick="resetSetting(event, this.id)">reset</button>
            |
            <button id="clear" onclick="clearSource(event, this.id)">clear</button>
            |
            <button id="export" disabled="disabled">export</button>
            <!--
                TODO: export script+result
                - document.execCommand("copy");
                - display script+result and export
            -->
            <button id="share" disabled="disabled">share</button>
            <!--
                TODO: share settings+script
                share with #hash, but not change the href
                !!!: alert for overwriting
                !!!: or supports history
            -->
        </div>
    </div>
    <div id="left" class="container">
        <textarea id="src" class="code" oninput="calculate(event, this.id)" onkeydown="shortcuts(event, this.id)" onscroll="syncScrolling(event, this.id)"></textarea>
    </div>
    <div id="right" class="container">
        <textarea readonly id="res" class="code" onscroll="syncScrolling(event, this.id)"></textarea>
        <textarea readonly id="ln" class="code" onscroll="syncScrolling(event, this.id)"></textarea>
    </div>
</body>
<script type="text/javascript">
    
    function Radix(num, radix) {
        let prefix = (radix == 2) ? "0b" : (radix == 8) ? "0o" : (radix == 16) ? "0x" : "";
        this.num = num;
        this.str = prefix + num.toString(radix).toUpperCase();
    }
    Math.format = function(num, radix) {
        return new Radix(num, radix);
    };
    
    for (let method of ["round", "floor", "ceil"]) {
        let _method = "_" + method;
        Math[_method] = Math[method];
        Math[method] = function(n, l) {
            return n[method](l);
        };
        Number.prototype[method] = function(n) {
            n = n || 0;
            if (Math.abs(n) > 100) return this.valueOf();
            n = n > 0 ? Math._floor(n) : Math._ceil(n);
            let m = Math.pow(10, n);
            return Math[_method](this * m) / m;
        };
    }
    
    const rest = ["number", "boolean"];
    
    // querySelector || querySelectorAll
    let $src = document.querySelector("#src");
    let $res = document.querySelector("#res");
    let $ln = document.querySelector("#ln");
    let $decimalDigits = document.querySelector("#decimalDigits");
    let $roundingMethod = document.querySelector("#roundingMethod");
    
    function calculate(event, id) {
        localStorage.setItem("data.src", $src.value);
        localStorage.setItem("setting.decimalDigits", $decimalDigits.selectedIndex);
        localStorage.setItem("setting.roundingMethod", $roundingMethod.selectedIndex);
        
        $roundingMethod.disabled = ($decimalDigits.selectedIndex == 0);
        
        /// prepare
        let src = $src.value
        .replace(/===/g, "==").replace(/==/g, "=").replace(/=/g, "==") // =, ==, === >> ==
        .replace(/==\s*\/\//, "//") // before comments
        .replace(/==\s*\n/, "\n") // before end of line
        .replace(/==\s*$/, ""); // bofore end of string
        
        let res = [], ln = [];
        let vals = [], vars = {}, funs = {};
        for (line of src.split("\n")) {
            line = line.trim();
            
            let r, str;
            try {
                if (vals.length >= 99) {
                    throw "too many calculations";
                }
                
                /// validate
                let commentIndex = line.indexOf("//");
                let code = commentIndex >= 0 ? line.slice(0, commentIndex).trim() : line;
                // symbols
                if (/[\[\]\{\}'"\\;]/g.test(code)) {
                    throw "invalid symbol in `" + line + "`";
                }
                
                let funcName;
                let funcArgs;
                let label;
                
                /// find `function`
                // `fun([arg0[, arg1]*]?):`
                let makeRegExp = (str, opts) => new RegExp(str.raw[0].replace(/\s/gm, ""), opts || "");
                // let regExp = /^(?<name>\b(?!\d)\w+)\s*(?<args>\((\s*\b(?!\d)\w+\s*(,\s*\b(?!\d)\w+\s*)*)?\))\:/;
                let regExp = makeRegExp`
                    ^
                    (?<name>\b(?!\d)\w+)\s*
                    (?<args>\((\s*
                        \b(?!\d)\w+\s*
                        (,\s*\b(?!\d)\w+\s*)*)?\)
                    )\:
                `;
                let funcMatches = code.match(regExp);
                if (funcMatches) {
                    funcName = funcMatches.groups.name;
                    if (Math[funcName] || Number.prototype[funcName]) {
                        throw "ivalid func in `" + line + "`";
                    }
                    funcArgs = funcMatches.groups.args;
                    code = code.slice(funcMatches.index + funcMatches[0].length).trim();
                }
                else {
                    /// find `label`
                    // `(word-start) (no-number) words (word-end) colon`
                    let labelMatches = code.match(/^\b(?!\d)\w+\b\s*\:/);
                    if (labelMatches) {
                        label = labelMatches[0].slice(0, -1).trim();
                        if (Math[label] || Number.prototype[label]) {
                            throw "ivalid label in `" + line + "`";
                        }
                        code = code.slice(labelMatches.index + labelMatches[0].length).trim();
                    }
                    
                    /// validate and insert namespace
                    // `(word-start) (no-number) words (word-end) [spaces] (left-parenthesis)`
                    code = code.replace(/\b(?!\d)\w+\b\s*(?=\()/g, function(name) {
                        name = name.trim();
                        if ((!funs[name] && !Math[name] && !Number.prototype[name]) || ["prototype", "toSource", "valueOf"].includes(name)) {
                            throw "invalid function in `" + line + "`";
                        }
                        return funs[name] && !Math[name] && !Number.prototype[name] ? ("funs." + name) : name;
                    });
                    
                    /// replace `label`
                    // `(word-start) (no-number) words (word-end) [spaces] (no-left-parenthesis)`
                    code = code.replace(/\b(?!\d)\w+\s*(?!\()\b/g, function(l) {
                        let v = vars[l];
                        return v !== undefined ? v : l; // `l` but NOT undefined for PI, NaN, MIN_VALUE, MAX_VALUE, ...
                    });
                    
                    /// replace `$x`
                    /// prepend `$` if `(line-start) (no-dollar) (no-left-parenthesis) (no-words)`
                    if (rest.includes(typeof res[res.length - 1]) && code.length && !code.match(/^[\$\(\w]+/)) {
                        code = "$ " + code;
                    }
                    // `dollar [numbers]`
                    code = code.replace(/\$\d*/g, function($x) {
                        if ($x == "$" || $x == "$0") return vars.$;
                        let i = Number($x.slice(1)) - 1;
                        return i >= 0 && i < vals.length ? vals[i] : undefined;
                    });
                }
                
                // /\.\s*\b(?!\d)\w+\b\s*\(/g - `dot [spaces] (word-start) (no-number) words (word-end) [spaces] left-parenthesis`
                // `(word-start) Number (word-end) [spaces] dot`
                if (/\bNumber\b\s*\./g.test(code)) {
                    throw "invalid dot in `" + line + "`";
                }
                
                /// eval
                with (Math) {
                    if (funcName && funcArgs) {
                        eval("funs." + funcName + " = " + funcArgs + " => " + code + ";");
                    }
                    else {
                        r = eval(code);
                    }
                }
                console.log(r ? (code + " = " + r) : code);
                
                if (r instanceof Radix) {
                    str = r.str;
                    r = r.num;
                }
                
                /// vars
                let type = typeof r;
                if (type == "number") {
                    let decimalDigits = Number($decimalDigits.value);
                    if (decimalDigits >= 0) {
                        let roundingMethod = $roundingMethod.value;
                        r = r[roundingMethod](decimalDigits);
                    }
                    vars.$ = r;
                    if (label) vars[label] = r;
                }
                else if (type == "boolean") {
                    vars.$ = r;
                    if (label) vars[label] = r;
                }
                else if (r) {
                    throw "invalid expression in `" + line + "`";
                }
            }
            catch(e) {
                console.warn(e);
                r = "ERROR";
            }
            
            /// res
            res.push(str || r);
            if (rest.includes(typeof r)) {
                vals.push(r);
                ln.push((vals.length < 10 ? " " : "") + vals.length);
            }
            else {
                ln.push("");
            }
        }
        
        /// output
        // let fixed = res.map((name, index) => name ? Number(name).toFixed(2) : name);
        $res.value = res.join("\n");
        $ln.value = ln.join("\n");
    }
    
    function shortcuts(event, id) {
        if (document.activeElement != $src
            || event.altKey || event.metaKey || event.repeat || event.isComposing) {
            return;
        }
        
        var key = event.key.toLowerCase();
        if (event.ctrlKey && ["c", "u"].includes(key)) {
            let value = $src.value;
            let start = $src.selectionStart, end = $src.selectionEnd;
            if (start == end) {
                while (start > 0 && value[start - 1].match(/[\w$]/)) {
                    start -= 1;
                }
                while (end < value.length - 1 && value[end].match(/[\w$]/)) {
                    end += 1;
                }
            }
            
            let selection = value.substring(start, end);
            if (key == "c") {
                selection = selection[0][event.shiftKey ? "toLowerCase" : "toUpperCase"]() + selection.substring(1);
            }
            else {
                selection = selection[event.shiftKey ? "toLowerCase" : "toUpperCase"]();
            }
            
            $src.selectionStart = start;
            $src.selectionEnd = end;
            document.execCommand("insertText", false, selection); // enable undo
            $src.selectionStart = start;
            $src.selectionEnd = end;
            
            calculate(null, id);
        }
    }
    
    function resetSetting(event, id) {
        $decimalDigits.selectedIndex = 0;
        $roundingMethod.selectedIndex = 0;
        calculate(null, id);
    }
    
    function clearSource(event, id) {
        $src.select();
        document.execCommand("insertText", false, ""); // enable undo
        calculate(null, id);
    }
    
    function syncScrolling(event, id) {
        let $el = document.getElementById(id);
        [$src, $res, $ln].forEach(function(e, i) {
            e.scrollTop = $el.scrollTop;
        });
    }
    
    $decimalDigits.selectedIndex = localStorage.getItem("setting.decimalDigits");
    $roundingMethod.selectedIndex = localStorage.getItem("setting.roundingMethod");
    $src.value = localStorage.getItem("data.src");
    
    $src.focus();
    calculate(null, null);
    
</script>
</html>
