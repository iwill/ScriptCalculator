<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>TextCalculator</title>
<style>
    html {
        box-sizing: border-box;
        font-family: monospace;
        font-size: 13px;
    }
    *, *:before, *:after {
        box-sizing: inherit;
        font-family: inherit;
        font-size: inherit;
    }
    
    #left,
    #right {
        line-height: 0;
    }
    #left {
        float: left;
        display: inline-block;
        width: calc(100% - 245px);
        margin: 0;
    }
    #right {
        float: left;
        display: inline-block;
        width: 240px;
        margin: 0 0 0 5px;
    }
    
    #src {
        text-align: right;
    }
    #res {
    }
    #src,
    #res {
        width: 100%;
        height: 320px;
        resize: none; /* horizontal */
        margin: 0;
        padding: 5px;
        line-height: 15px;
        border-style: solid;
        border-width: 1px;
        border-color: gray;
    }
    
    #src::-webkit-scrollbar,
    #res::-webkit-scrollbar {
        width: 0px;
        background: transparent; /* make scrollbar transparent */
    }
</style>
</head>
<body>
    <div style="float: right; padding: 5px 0;">
        DecimalDigits: <select id="decimalDigits" onchange="calculate(event, this.id)">
            <option value="-1">--</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
        </select>
        RoundingMethod: <select id="roundingMethod" onchange="calculate(event, this.id)">
            <option value="round">round</option>
            <option value="floor">floor</option>
            <option value="ceil">ceil</option>
        </select>
        <button id="reset" onclick="resetSetting(event, this.id)">reset</button>
        |
        <button id="clear" onclick="clearSource(event, this.id)">clear</button>
        <!-- TODO: history -->
        |
        <button id="copy">copy</button><!-- TODO: document.execCommand("copy"); -->
        <button id="share">share</button><!-- TODO: share with #hash, but not change the href, !!!: alert for overwriting -->
    </div>
    <div id="left">
        <textarea id="src" onkeyup="calculate(event, this.id)" onscroll="syncScrolling(event, this.id)"></textarea>
    </div>
    <div id="right">
        <!-- TODO: line-number for variables -->
        <textarea readonly id="res" onscroll="syncScrolling(event, this.id)"></textarea>
    </div>
</body>
<script type="text/javascript">
    var $src = document.getElementById("src");
    var $res = document.getElementById("res");
    var $decimalDigits = document.getElementById("decimalDigits");
    var $roundingMethod = document.getElementById("roundingMethod");
    
    function calculate(event, id) {
        localStorage.setItem("data.src", $src.value);
        localStorage.setItem("setting.decimalDigits", $decimalDigits.selectedIndex);
        localStorage.setItem("setting.roundingMethod", $roundingMethod.selectedIndex);
        
        $roundingMethod.disabled = ($decimalDigits.selectedIndex == 0);
        
        /// prepare
        var src = $src.value
        .replace(/=/g, "==")
        .replace(/==\ *\/\//g, "//")
        .replace(/==\ *\n/g, "\n")
        .replace(/==\ *$/, "");
        var source = src.split("\n");
        
        var res = [];
        var vars = {};
        for (line of source) {
            var r;
            try {
                /// validate
                var commentIndex = line.indexOf("//");
                var code = commentIndex >= 0 ? line.slice(0, commentIndex) : line;
                if (code.search(/[\[\]\{\}'";]/g) >= 0) {
                    throw "invalid symbol in `" + line + "`";
                }
                if (code.search(/\.\s*[A-z_$]+[A-z0-9_$]*\s*?\(/g) >= 0) {
                    throw "invalid dot in `" + line + "`";
                }
                (code.match(/\w+\s*\(/g) || []).forEach(function(name, i) {
                    name = name.slice(0, -1).trim();
                    if (!Math[name] || name == "prototype" || name == "toSource" || name == "valueOf") {
                        throw "invalid function in `" + line + "`";
                    }
                });
                
                /// get variable
                var v = line.match(/^\b[A-z_$]+[A-z0-9_$]*\:/);
                if (v) {
                    line = line.slice(v.index + v[0].length);
                }
                
                /// set variable
                line = line.replace(/\b[A-z_$]+[A-z0-9_$]*/g, function(key) {
                    return vars[key] || key;
                });
                
                /// set $x
                var nonNullRes = res.filter(function(r) {
                    return r || r === 0;
                });
                line = line.replace(/\$\d*/g, function($x) {
                    if ($x == "$" || $x == "$0") return vars.$;
                    var i = Number($x.slice(1)) - 1;
                    return i >= 0 && i < nonNullRes.length ? nonNullRes[i] : $x;
                });
                
                /// eval
                with (Math) {
                    r = eval(line);
                }
                
                /// vars
                var type = typeof r;
                if (type == "number") {
                    var decimalDigits = Number($decimalDigits.value);
                    if (decimalDigits >= 0) {
                        var roundingMethod = $roundingMethod.value;
                        var mi = Math.pow(10, decimalDigits);
                        r = Math[roundingMethod](r * mi) / mi;
                    }
                    vars.$ = r;
                }
                else if (type == "boolean") {
                    vars.$ = r;
                }
                else if (r) {
                    throw "invalid expression in `" + line + "`";
                }
                if (v) {
                    var key = v[0].slice(0, -1);
                    vars[key] = r;
                }
            }
            catch(e) {
                r = "ERROR";
            }
            
            /// res
            res.push(r);
        }
        
        /// output
        // var fixed = res.map((name, index) => name ? Number(name).toFixed(2) : name);
        $res.value = res.join("\n");
    }
    
    function resetSetting(event, id) {
        $decimalDigits.selectedIndex = 0;
        $roundingMethod.selectedIndex = 0;
        calculate(null, id);
    }
    
    function clearSource(event, id) {
        $src.select();
        document.execCommand("insertText", false, "");
        calculate(null, id);
    }
    
    function syncScrolling(event, id) {
        var targetID = (id == "res" ? "src" : "res");
        document.getElementById(targetID).scrollTop = document.getElementById(id).scrollTop;
    }
    
    $decimalDigits.selectedIndex = localStorage.getItem("setting.decimalDigits");
    $roundingMethod.selectedIndex = localStorage.getItem("setting.roundingMethod");
    $src.value = localStorage.getItem("data.src");
    calculate(null, null);
    
</script>
</html>
