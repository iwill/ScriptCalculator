<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>TextCalculator</title>
<style>
    html {
        box-sizing: border-box;
    }
    *, *:before, *:after {
        box-sizing: inherit;
    }
    
    #left,
    #right {
        line-height: 0;
    }
    #left {
        float: left;
        display: inline-block;
        width: calc(100% - 245px);
        margin: 0;
    }
    #right {
        float: left;
        display: inline-block;
        width: 240px;
        margin: 0 0 0 5px;
    }
    
    #src {
        text-align: right;
    }
    #res {
    }
    #src,
    #res {
        width: 100%;
        height: 320px;
        resize: none; /* horizontal */
        font-family: monospace;
        font-size: 13px;
        margin: 0;
        padding: 5px;
        line-height: 15px;
        border-style: solid;
        border-width: 1px;
        border-color: gray;
    }
    
    #src::-webkit-scrollbar,
    #res::-webkit-scrollbar {
        width: 0px;
        background: transparent; /* make scrollbar transparent */
    }
    
    button {
        border-style: none;
        font-size: 13px;
        cursor: pointer;
    }
</style>
</head>
<body>
    <div id="left">
        <textarea id="src" onkeyup="calculate(event, this.id)" onscroll="syncScrolling(event, this.id)"></textarea>
    </div>
    <div id="right">
        <textarea readonly id="res" onscroll="syncScrolling(event, this.id)"></textarea>
    </div>
</body>
<script type="text/javascript">
    function calculate(event, id) {
        var value = document.getElementById(id).value;
        localStorage.setItem("value", value);
        
        /// prepare
        var src = document.getElementById(id).value
        .replace(/=/g, "==")
        .replace(/==\ *\/\//g, "//")
        .replace(/==\ *\n/g, "\n")
        .replace(/==\ *$/, "");
        var source = src.split("\n");
        
        var res = [];
        var vars = {};
        for (line of source) {
            var r;
            try {
                /// validate
                var commentIndex = line.indexOf("//");
                var code = commentIndex >= 0 ? line.slice(0, commentIndex) : line;
                if (code.search(/[\[\]\{\},'";]/g) >= 0) {
                    throw "invalid symbol in `" + line + "`"
                }
                if (code.search(/\.\s*[A-z_$]+[A-z0-9_$]*\s*?\(/g) >= 0) {
                    throw "invalid dot in `" + line + "`"
                }
                (code.match(/\w+\s*\(/g) || []).forEach(function(name, i) {
                    name = name.slice(0, -1).trim();
                    if (!Math[name]) {
                        throw "invalid function in `" + line + "`"
                    }
                });
                
                /// get variable
                var v = line.match(/^\b[A-z_$]+[A-z0-9_$]*\:/);
                if (v) {
                    line = line.slice(v.index + v[0].length);
                }
                
                /// set variable
                line = line.replace(/\b[A-z_$]+[A-z0-9_$]*/g, function(key) {
                    return vars[key] || key;
                });
                
                /// set $x
                var nonNullRes = res.filter(function(r) {
                    return r || r === 0
                });
                line = line.replace(/\$\d*/g, function($x) {
                    if ($x == "$" || $x == "$0") return vars.$;
                    var i = Number($x.slice(1)) - 1;
                    return i >= 0 && i < nonNullRes.length ? nonNullRes[i] : $x;
                });
                
                /// eval
                with (Math) {
                    r = eval(line);
                }
                if (r && r != true && typeof r != "number") {
                    throw "invalid expression in `" + line + "`" 
                }
                
                /// vars
                if (r || r === 0) {
                    vars.$ = r;
                }
                if (v) {
                    var key = v[0].slice(0, -1);
                    vars[key] = r;
                }
            }
            catch(e) {
                r = "ERROR";
            }
            
            /// res
            res.push(r);
        }
        
        /// output
        // var fixed = res.map((name, index) => name ? Number(name).toFixed(2) : name);
        document.getElementById("res").value = res.join("\n");
    }
    
    function syncScrolling (event, id) {
        var targetID = (id == "res" ? "src" : "res");
        document.getElementById(targetID).scrollTop = document.getElementById(id).scrollTop;
    }
    
    document.getElementById("src").value = localStorage.getItem("value");
    calculate(null, "src");
    
    // TODO:
    // `document.execCommand("copy");`
    
</script>
</html>
