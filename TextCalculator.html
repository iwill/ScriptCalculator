<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>TextCalculator</title>
<style type="text/css" media="all">
    html {
        --space: 5px;
    }
    body {
        --top-height: 30px;
        --right-width: 240px;
        --ln-width: 20px;
    }
    
    html {
        box-sizing: border-box;
        font-family: monospace;
        font-size: 13px;
    }
    *, *:before, *:after {
        box-sizing: inherit;
        font-family: inherit;
        font-size: inherit;
    }
    html {
        height: 100%;
        padding: 0;
    }
    body {
        --margin: 8px;
        height: calc(100% - var(--margin) * 2);
        margin: var(--margin);
        padding: 0;
    }
    
    #right {
        width: var(--right-width);
        margin: 0 0 0 var(--space);
        position: relative;
    }
    #left {
        width: calc(100% - var(--right-width) - var(--space));
        margin: 0;
    }
    .container {
        height: calc(100% - var(--top-height) - var(--space) * 2);
        float: left;
        display: inline-block;
        line-height: 0;
    }
    
    #src {
        text-align: right;
    }
    #res {
        padding-left: calc(var(--ln-width) + var(--space));
    }
    #ln {
        pointer-events: none;
        position: absolute;
        left: 0;
        top: 0;
        width: var(--ln-width);
        padding: var(--space) 1px;
        border-color: transparent;
        background-clip: padding-box;
        background-color: #00000008;
        color: #AAAAAA;
        text-align: right;
    }
    .code {
        width: 100%;
        height: 100%;
        resize: none;
        /* overflow-x: hidden; */
        margin: 0;
        padding: var(--space);
        border-style: solid;
        border-width: 1px;
        border-color: gray;
        line-height: 15px;
        white-space: pre;
    }
    .code::-webkit-scrollbar {
        width: 0;
        background: transparent;
    }
</style>
</head>
<body>
    <div style="height: var(--top-height); float: right; padding: var(--space) 0;">
        DecimalDigits: <select id="decimalDigits" onchange="calculate(event, this.id)">
            <option value="-1">--</option>
            <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option>
            <option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option>
            <option value="15">15</option><option value="16">16</option>
        </select>
        RoundingMethod: <select id="roundingMethod" onchange="calculate(event, this.id)">
            <option value="round">round</option><option value="floor">floor</option><option value="ceil">ceil</option>
        </select>
        <button id="reset" onclick="resetSetting(event, this.id)">reset</button>
        |
        <button id="clear" onclick="clearSource(event, this.id)">clear</button>
        |
        <button id="copy">copy</button><!-- TODO: document.execCommand("copy"); -->
        <button id="share">share</button><!-- TODO: share with #hash, but not change the href, !!!: alert for overwriting or supports history -->
    </div>
    <div id="left" class="container">
        <textarea id="src" class="code" onkeyup="calculate(event, this.id)" onscroll="syncScrolling(event, this.id)"></textarea>
    </div>
    <div id="right" class="container">
        <textarea readonly id="res" class="code" onscroll="syncScrolling(event, this.id)"></textarea>
        <textarea readonly id="ln" class="code" onscroll="syncScrolling(event, this.id)"></textarea>
    </div>
</body>
<script type="text/javascript">
    let $src = document.querySelector("#src");
    let $res = document.querySelector("#res");
    let $ln = document.querySelector("#ln");
    let $decimalDigits = document.querySelector("#decimalDigits");
    let $roundingMethod = document.querySelector("#roundingMethod");
    
    function calculate(event, id) {
        localStorage.setItem("data.src", $src.value);
        localStorage.setItem("setting.decimalDigits", $decimalDigits.selectedIndex);
        localStorage.setItem("setting.roundingMethod", $roundingMethod.selectedIndex);
        
        $roundingMethod.disabled = ($decimalDigits.selectedIndex == 0);
        
        /// prepare
        let src = $src.value
        .replace(/=/g, "==")
        .replace(/==\ *\/\//g, "//")
        .replace(/==\ *\n/g, "\n")
        .replace(/==\ *$/, "");
        
        let res = [], vals = [];
        let ln = [];
        let vars = {};
        for (line of src.split("\n")) {
            let r;
            try {
                if (vals.length >= 99) {
                    throw "too many calculations";
                }
                
                /// validate
                let commentIndex = line.indexOf("//");
                let code = commentIndex >= 0 ? line.slice(0, commentIndex) : line;
                // symbols
                if (/[\[\]\{\}'"\\;]/g.test(code)) {
                    throw "invalid symbol in `" + line + "`";
                }
                // `dot [spaces] (word-start) (non-number) words (word-end) [spaces] left-parenthesis`
                if (/\.\s*\b(?!\d)\w+\b\s*\(/g.test(code)) {
                    throw "invalid dot in `" + line + "`";
                }
                // `(word-start) (non-number) words (word-end) [spaces] left-parenthesis`
                (code.match(/\b(?!\d)\w+\b\s*\(/g) || []).forEach(function(name, i) {
                    name = name.slice(0, -1).trim();
                    if (!Math[name] || name == "prototype" || name == "toSource" || name == "valueOf") {
                        throw "invalid function in `" + line + "`";
                    }
                });
                
                /// get variable
                let key;
                // `(word-start) (non-number) words (word-end) colon`
                let label = line.match(/^\b(?!\d)\w+\b\:/);
                if (label) {
                    key = label[0].slice(0, -1);
                    if (Math[key]) {
                        throw "ivalid label in `" + line + "`";
                    }
                    line = line.slice(label.index + label[0].length);
                }
                
                /// set variable
                // `(word-start) (non-number) words (word-end)`
                line = line.replace(/\b(?!\d)\w+\b/g, function(v) {
                    return vars[v] || v;
                });
                
                /// set $x
                // `dollar [numbers]`
                line = line.replace(/\$\d*/g, function($x) {
                    if ($x == "$" || $x == "$0") return vars.$;
                    let i = Number($x.slice(1)) - 1;
                    return i >= 0 && i < vals.length ? vals[i] : undefined;
                });
                
                /// eval
                with (Math) {
                    r = eval(line);
                }
                
                /// vars
                let type = typeof r;
                if (type == "number") {
                    let decimalDigits = Number($decimalDigits.value);
                    if (decimalDigits >= 0) {
                        let roundingMethod = $roundingMethod.value;
                        let mi = Math.pow(10, decimalDigits);
                        r = Math[roundingMethod](r * mi) / mi;
                    }
                    vars.$ = r;
                }
                else if (type == "boolean") {
                    vars.$ = r;
                }
                else if (r) {
                    throw "invalid expression in `" + line + "`";
                }
                if (key) {
                    vars[key] = r;
                }
            }
            catch(e) {
                r = "ERROR";
            }
            
            /// res
            res.push(r);
            if (typeof r == "number") {
                vals.push(r);
                ln.push((vals.length < 10 ? " " : "") + vals.length);
            }
            else {
                ln.push("");
            }
        }
        
        /// output
        // let fixed = res.map((name, index) => name ? Number(name).toFixed(2) : name);
        $res.value = res.join("\n");
        $ln.value = ln.join("\n");
    }
    
    function resetSetting(event, id) {
        $decimalDigits.selectedIndex = 0;
        $roundingMethod.selectedIndex = 0;
        calculate(null, id);
    }
    
    function clearSource(event, id) {
        $src.select();
        document.execCommand("insertText", false, "");
        calculate(null, id);
    }
    
    function syncScrolling(event, id) {
        let $el = document.getElementById(id);
        [$src, $res, $ln].forEach(function(e, i) {
            e.scrollTop = $el.scrollTop;
        });
    }
    
    $decimalDigits.selectedIndex = localStorage.getItem("setting.decimalDigits");
    $roundingMethod.selectedIndex = localStorage.getItem("setting.roundingMethod");
    $src.value = localStorage.getItem("data.src");
    
    $src.focus();
    calculate(null, null);
    
</script>
</html>
